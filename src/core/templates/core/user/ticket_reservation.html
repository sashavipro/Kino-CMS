{% extends 'core/user/layout.html' %}
{% block title %}Бронирование билета{% endblock %}
{% block cssstyle %}
<style>
    .seat { width: 30px; height: 30px; margin: 3px; border-radius: 5px; cursor: pointer; background-color: #6c757d; color: white; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; }
    .seat.available:hover { background-color: #5a6268; }
    .seat.selected { background-color: #28a745; border: 2px solid #1e7e34; }
    .seat.booked { background-color: #dc3545; cursor: not-allowed; }
    .screen { text-align: center; font-weight: bold; letter-spacing: 5px; padding: 10px; background-color: #343a40; color: white; margin-bottom: 20px; }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-4">
            <img src="{{ session.film.main_image.url }}" alt="{{ session.film.title }}" class="img-fluid rounded">
        </div>
        <div class="col-md-8 text-black">
            <div class="mb-4">
                <div class="text-white bg-danger p-2"><strong>{{ session.film.title|upper }}</strong></div>
                <p><strong>{{ session.date|date:"d E" }}, {{ session.time|time:"H:i" }}, {{ session.hall.cinema.name }}, {{ session.hall.number_hall }}</strong></p>
                <div class="bg-warning text-dark p-2 rounded">
                    <strong>ВАШИ БИЛЕТЫ НА ЭТОТ СЕАНС:</strong>
                    <span class="d-block">Всего билетов: {{ user_ticket_count }}</span>
                    <span class="d-block">Уже оплачено/забронировано: {{ user_total_spent }} грн.</span>
                    <hr class="my-1">
                    <strong>ТЕКУЩИЙ ВЫБОР:</strong>
                    <span class="d-block">Выбрано для покупки/брони: <span id="selectionCount">0</span></span>
                    <span class="d-block fw-bold">Сумма к оплате/брони: <span id="selectionSum">0</span> грн.</span>
                </div>
            </div>

            <div class="screen">ЭКРАН</div>

            <div id="seats-map" class="text-center">
                {% for row_num in hall_layout.rows %}
                    <div class="seat-row d-flex justify-content-center align-items-center">
                        <div style="width: 50px;">РЯД {{ row_num }}</div>
                        {% for seat_num in hall_layout.seats %}
                            <div class="seat" data-row="{{ row_num }}" data-seat="{{ seat_num }}">
                                {{ seat_num }}
                            </div>
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>

            <hr class="my-4">
            <form id="bookingForm" method="POST">
                {% csrf_token %}
                <input type="hidden" name="selected_seats" id="selectedSeatsInput">
                <!-- Скрытое поле, чтобы передать, какая кнопка нажата -->
                <input type="hidden" name="action" id="actionInput">

                <div class="actions d-grid gap-2 d-md-flex">
                    <button type="submit" id="bookBtn" class="btn btn-primary" data-action="book">
                        Забронировать за {{ booking_fee }} грн
                    </button>
                    <button type="submit" id="buyBtn" class="btn btn-success" data-action="buy">
                        Купить за {{ session.price }} грн
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Константы цен ---
        const sessionPrice = {{ session.price }};
        const bookingFee = {{ booking_fee }};
        const bookedSeats = {{ booked_seats|safe }};

        // --- Элементы DOM ---
        const seatsMap = document.getElementById('seats-map');
        const selectionCountEl = document.getElementById('selectionCount');
        const selectionSumEl = document.getElementById('selectionSum');
        const selectedSeatsInput = document.getElementById('selectedSeatsInput');
        const actionInput = document.getElementById('actionInput');
        const bookingForm = document.getElementById('bookingForm');

        let selectedSeats = [];
         // --- Инициализация зала (отмечаем занятые места) ---
    document.querySelectorAll('.seat').forEach(seat => {
        const seatId = `${seat.dataset.row}-${seat.dataset.seat}`;
        if (bookedSeats.includes(seatId)) {
            seat.classList.add('booked');
        } else {
            seat.classList.add('available');
        }
    });

    // --- Обработчик клика на место ---
    seatsMap.addEventListener('click', function(e) {
        const seat = e.target;
        if (seat.classList.contains('available')) {
            const seatId = `${seat.dataset.row}-${seat.dataset.seat}`;

            // Добавляем или убираем место из списка выбранных
            if (selectedSeats.includes(seatId)) {
                selectedSeats = selectedSeats.filter(s => s !== seatId);
                seat.classList.remove('selected');
            } else {
                selectedSeats.push(seatId);
                seat.classList.add('selected');
            }
            updateOrderSummary();
        }
    });

    // --- Обработчик отправки формы ---
    bookingForm.addEventListener('submit', function(e) {
        // `document.activeElement` это кнопка, на которую нажали для отправки
        const action = document.activeElement.dataset.action;
        if (action) {
            actionInput.value = action;
        } else {
            // Если форма отправлена не кнопкой (например, Enter), по умолчанию - бронь
            actionInput.value = 'book';
        }
    });

    // --- Функция обновления информации о ТЕКУЩЕМ ВЫБОРЕ ---
    function updateOrderSummary() {
        const count = selectedSeats.length;

        // Показываем сумму для брони и покупки для наглядности
        const bookingTotal = count * bookingFee;
        const buyingTotal = count * sessionPrice;

        selectionCountEl.textContent = count;
        // Показываем обе суммы, чтобы пользователь видел варианты
        selectionSumEl.textContent = `${bookingTotal} (бронь) / ${buyingTotal} (покупка)`;

        // Записываем ID выбранных мест в скрытое поле
        selectedSeatsInput.value = JSON.stringify(selectedSeats);
    }
});
</script>
{% endblock %}