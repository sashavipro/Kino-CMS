{% extends 'core/user/layout.html' %}
{% block title %}Бронирование билета{% endblock %}
{% block cssstyle %}
<style>
    .seat { width: 30px; height: 30px; margin: 3px; border-radius: 5px; cursor: pointer; background-color: #6c757d; color: white; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; }
    .seat.available:hover { background-color: #5a6268; }
    .seat.selected { background-color: #28a745; border: 2px solid #1e7e34; }
    .seat.booked { background-color: #dc3545; cursor: not-allowed; }
    .screen { text-align: center; font-weight: bold; letter-spacing: 5px; padding: 10px; background-color: #343a40; color: white; margin-bottom: 20px; }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-4">
            <img src="{{ session.film.main_image.url }}" alt="{{ session.film.title }}" class="img-fluid rounded">
        </div>
        <div class="col-md-8 text-black">
            <div class="mb-4">
                <div class="text-white bg-danger p-2"><strong>{{ session.film.title|upper }}</strong></div>
                <p><strong>{{ session.date|date:"d E" }}, {{ session.time|time:"H:i" }}, {{ session.hall.cinema.name }}, {{ session.hall.number_hall }}</strong></p>
                <div class="bg-warning text-dark p-2 rounded">
                    <strong>ВАШИ БИЛЕТЫ НА ЭТОТ СЕАНС:</strong>
                    <span class="d-block">Всего билетов: {{ user_ticket_count }}</span>
                    <span class="d-block">Уже оплачено/забронировано: {{ user_total_spent }} грн.</span>
                    <hr class="my-1">
                    <strong>ТЕКУЩИЙ ВЫБОР:</strong>
                    <span class="d-block">Выбрано для покупки/брони: <span id="selectionCount">0</span></span>
                    <span class="d-block fw-bold">Сумма к оплате/брони: <span id="selectionSum">0</span> грн.</span>
                </div>
            </div>

            <div class="screen">ЭКРАН</div>

            <div id="seats-map" class="text-center">
                {% for row_num in hall_layout.rows %}
                    <div class="seat-row d-flex justify-content-center align-items-center">
                        <div style="width: 50px;">РЯД {{ row_num }}</div>
                        {% for seat_num in hall_layout.seats %}
                            <div class="seat" data-row="{{ row_num }}" data-seat="{{ seat_num }}">
                                {{ seat_num }}
                            </div>
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>

            <hr class="my-4">
        {% if user.is_authenticated %}
            <form id="bookingForm" method="POST">
                {% csrf_token %}
                <input type="hidden" name="selected_seats" id="selectedSeatsInput">
                <!-- Скрытое поле, чтобы передать, какая кнопка нажата -->
                <input type="hidden" name="action" id="actionInput">

                <div class="actions d-grid gap-2 d-md-flex">
                    <button type="button" id="bookBtn" class="btn btn-primary" data-action="book">Забронировать за {{ booking_fee }} грн</button>
                    <button type="button" id="buyBtn" class="btn btn-success" data-action="buy">Купить за {{ session.price }} грн</button>
                </div>
            </form>
        {% else %}
            <div class="alert alert-info">
                <strong><a href="{% url 'users:login' %}?next={{ request.path }}">Войдите в аккаунт</a></strong>, чтобы забронировать или купить билеты.
            </div>
        {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Константы цен ---
    const sessionPrice = {{ session.price }};
    const bookingFee = {{ booking_fee }};
    let bookedSeats = {{ initial_booked_seats|safe }}; // Начальное состояние
    const sessionId = {{ session.id }};
    const csrfToken = '{{ csrf_token }}';

    // --- Элементы DOM ---
    const seatsMap = document.getElementById('seats-map');
    const selectionCountEl = document.getElementById('selectionCount');
    const selectionSumEl = document.getElementById('selectionSum');
    const bookBtn = document.getElementById('bookBtn');
    const buyBtn = document.getElementById('buyBtn');

    let selectedSeats = [];
    let seatUpdateInterval;

     // 1. Обновление всего зала на основе массива `bookedSeats`
    function renderHall() {
        document.querySelectorAll('.seat').forEach(seat => {
            const seatId = `${seat.dataset.row}-${seat.dataset.seat}`;
            seat.classList.remove('booked', 'available', 'selected'); // Сбрасываем все классы

            if (bookedSeats.includes(seatId)) {
                seat.classList.add('booked');
            } else if (selectedSeats.includes(seatId)) {
                seat.classList.add('selected');
            } else {
                seat.classList.add('available');
            }
        });
    }

    // 2. Обновление информации о заказе
    function updateOrderSummary() {
        const count = selectedSeats.length;
        selectionCountEl.textContent = count;
        selectionSumEl.textContent = `${count * bookingFee} (бронь) / ${count * sessionPrice} (покупка)`;
    }

    // 3. Показ сообщений (замена Django Messages)
    function showMessage(text, type = 'success') {
        const container = document.getElementById('messages-container');
        const alert = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${text}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>`;
        container.innerHTML += alert;
    }

    // 4. AJAX-запрос для бронирования/покупки
    function processBooking(action) {
        if (selectedSeats.length === 0) {
            showMessage('Вы не выбрали ни одного места.', 'warning');
            return;
        }

        fetch(`/api/process_booking/${sessionId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                selected_seats: selectedSeats,
                action: action
            })
        })
        .then(response => response.json().then(data => ({ status: response.status, body: data })))
        .then(({ status, body }) => {
            showMessage(body.message, body.status === 'success' ? 'success' : 'danger');
            if (body.status === 'success') {
                // Обновляем состояние зала и сбрасываем выбор
                bookedSeats = bookedSeats.concat(selectedSeats);
                selectedSeats = [];
                renderHall();
                updateOrderSummary();
            }
        })
        .catch(error => console.error('Booking error:', error));
    }

    // 5. AJAX-запрос для обновления состояния зала
    function fetchSeatUpdates() {
        fetch(`/api/session_seats/${sessionId}/`)
            .then(response => response.json())
            .then(data => {
                bookedSeats = data.booked_seats;
                renderHall(); // Перерисовываем зал с новыми данными
            });
    }

    // --- Инициализация и обработчики событий ---
    renderHall(); // Первоначальная отрисовка зала

    seatsMap.addEventListener('click', function(e) {
        const seat = e.target;
        if (!seat.classList.contains('available')) return;

        const seatId = `${seat.dataset.row}-${seat.dataset.seat}`;
        if (selectedSeats.includes(seatId)) {
            selectedSeats = selectedSeats.filter(s => s !== seatId);
        } else {
            selectedSeats.push(seatId);
        }
        renderHall();
        updateOrderSummary();
    });

    if (bookBtn && buyBtn) {
        bookBtn.addEventListener('click', () => processBooking('book'));
        buyBtn.addEventListener('click', () => processBooking('buy'));
    }

    // Запускаем периодический опрос состояния зала каждые 5 секунд
    seatUpdateInterval = setInterval(fetchSeatUpdates, 5000);
});

</script>
{% endblock %}