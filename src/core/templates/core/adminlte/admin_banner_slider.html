{% extends 'core/adminlte/admin_layout.html' %}
{% load static %}

{% block content %}

<!-- begin. На главной верх -->
<div class="card shadow-sm">
  <div class="card-header"><h3 class="card-title mb-0">На главной верх</h3></div>
  <div class="card-body">
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="hidden" name="action" value="save_home_slides">

      <!-- Управление -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="switch_home" name="home_status" {% if home_slides and home_slides.0.status_banner %}checked{% endif %}>
          <label class="form-check-label" for="switch_home">ВКЛ</label>
        </div>
        <div>
          <label class="form-label me-2">Скорость (сек):</label>
          <select name="speed" class="form-select w-auto d-inline-block">
            {% for speed in speed_choices %}<option value="{{ speed }}" {% if home_slides.0.speed_banner == speed %}selected{% endif %}>{{ speed }}</option>{% endfor %}
          </select>
        </div>
      </div>

      <!-- Слайды -->
      <div class="d-flex flex-wrap gap-3">
        {% for banner in home_slides %}
          <div class="border rounded p-2 text-center position-relative" style="width: 180px;">
            <button type="submit" name="delete_id" value="{{ banner.id }}" class="btn-close position-absolute top-0 end-0"></button>
            <div class="border bg-light d-flex align-items-center justify-content-center" style="height: 100px;">
              {% if banner.image and banner.image.image %}
                <img src="{{ banner.image.image.url }}" class="img-fluid" style="max-height: 96px;" id="preview-home-{{ banner.id }}">
              {% else %}
                <i class="fa-solid fa-image fa-2x text-muted" id="preview-home-{{ banner.id }}"></i>
              {% endif %}
            </div>
            <input type="file" name="{{ banner.id }}-upload_image"  class="form-control form-control-sm mt-2" onchange="previewImage(this, 'preview-home-{{ banner.id }}')">
            <div class="mt-2">
              <input type="text"  name="{{ banner.id }}-url_banner"  class="form-control form-control-sm mb-1" placeholder="URL"  value="{{ banner.url_banner|default:'' }}">
              <input type="text" name="{{ banner.id }}-text_banner"  class="form-control form-control-sm" placeholder="Текст" value="{{ banner.text_banner|default:'' }}">
            </div>
          </div>
        {% endfor %}
        <div class="d-flex align-items-center justify-content-center border rounded p-2" style="width: 180px;">
          <button type="submit" name="action" value="add_home_slide" class="btn btn-outline-success btn-sm w-100"><i class="fa-solid fa-plus"></i> Добавить</button>
        </div>
      </div>
      <div class="mt-3"><button type="submit" class="btn btn-primary">Сохранить все изменения</button></div>
    </form>
  </div>
</div>


<!-- end. На главной верх -->


<!-- Сквозной баннер на заднем фоне -->
<div class="card shadow-sm mt-4">
  <div class="card-header">
    <h3 class="card-title mb-0">Сквозной баннер на заднем фоне</h3>
  </div>
  <div class="card-body">
    <form method="post" enctype="multipart/form-data" class="d-flex gap-3">
      {% csrf_token %}

      <input type="hidden" name="action" value="save_background">

      <div>
        <!-- Status -->
        <div class="col-md-6 mb-3">
          <div class="form-check form-switch">
               <input class="form-check-input" type="checkbox" id="switch_bg" name="background_status" {% if background and background.status_banner %}checked{% endif %}>
            <label class="form-check-label" for="switch">ВКЛ</label>
          </div>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="mode" value="image"
                 id="bgImage" {% if background and background.image_banner %}checked{% endif %}>
          <label class="form-check-label" for="bgImage">Картинка на фоне</label>
        </div>

        <div class="form-check mt-2 d-flex align-items-center">
          <input class="form-check-input" type="radio" name="mode" value="color"
                 id="bgColor" {% if background and background.color %}checked{% endif %}>
          <label class="form-check-label me-2" for="bgColor">Цвет фона</label>
          <input type="text" name="color" class="form-control form-control-sm"
               style="width: 120px;"
               value="{{ background.color|default:'' }}"
               placeholder="red или #HEX">
        </div>
      </div>

    <!-- Превью -->
      <div class="d-flex align-items-start gap-3">
        <div class="border rounded bg-light d-flex align-items-center justify-content-center"
             style="width:150px; height:100px;">
          {% if background and background.image_banner %}
            <img src="{{ background.image_banner.url }}" class="img-fluid" style="max-height:96px;">
          {% elif background and background.color %}
            <div style="width:100%; height:100%; background: {{ background.color }};"></div>
          {% else %}
            <span class="text-muted">Нет фона</span>
          {% endif %}
        </div>


        <div class="d-flex flex-column gap-2">
          <input type="file" name="image" class="form-control form-control-sm">
          <div class="d-flex gap-2">
            <button class="btn btn-success btn-sm" type="submit">Сохранить</button>
            <button class="btn btn-danger btn-sm" type="submit" name="action" value="delete_background">Удалить</button>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>


<!-- begin. На главной Новости Акции -->
<div class="card shadow-sm mt-4">
  <div class="card-header"><h3 class="card-title mb-0">На главной Новости и Акции</h3></div>
  <div class="card-body">
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="hidden" name="action" value="save_news_slides">
      <div class="form-check form-switch mb-3">
        <input class="form-check-input" type="checkbox" id="switch_news" name="news_status" {% if news_slides and news_slides.0.status_banner %}checked{% endif %}>
        <label class="form-check-label" for="switch_news">ВКЛ</label>
      </div>

      <div class="d-flex flex-wrap gap-3">
        {% for banner in news_slides %}
          <div class="border rounded p-2 text-center position-relative" style="width: 180px;">
            <button type="submit" name="delete_id" value="{{ banner.id }}" class="btn-close position-absolute top-0 end-0"></button>
            <div class="border bg-light d-flex align-items-center justify-content-center" style="height: 100px;">
              <!-- ИСПРАВЛЕНО: используем новую структуру -->
              {% if banner.image and banner.image.image %}
                <img src="{{ banner.image.image.url }}" class="img-fluid" style="max-height: 96px;" id="preview-news-{{ banner.id }}">
              {% else %}
                <i class="fa-solid fa-image fa-2x text-muted" id="preview-news-{{ banner.id }}"></i>
              {% endif %}
            </div>
            <!-- ИСПРАВЛЕНО: имя поля для загрузки -->
            <input type="file" name="{{ banner.id }}-upload_image" class="form-control form-control-sm mt-2" onchange="previewImage(this, 'preview-news-{{ banner.id }}')">
            <div class="mt-2">
              <input type="text" name="{{ banner.id }}-url_banner" class="form-control form-control-sm" placeholder="URL" value="{{ banner.url_banner|default:'' }}">
            </div>
          </div>
        {% endfor %}
        <div class="d-flex align-items-center justify-content-center border rounded p-2" style="width: 180px;">
          <button type="submit" name="action" value="add_news_slide" class="btn btn-outline-success btn-sm w-100"><i class="fa-solid fa-plus"></i> Добавить</button>
        </div>
      </div>
      <div class="mt-3"><button type="submit" class="btn btn-primary">Сохранить изменения</button></div>
    </form>
  </div>
</div>

<!-- end. На главной Новости Акции -->
<script>
document.addEventListener('change', function(e){
  if(e.target.classList.contains('js-image-select')){
    const card = e.target.closest('form');
    const box = card.querySelector('.border.bg-light');
    const val = e.target.value; // 'img/xxx.jpg'
    if(!box) return;
    if(val){
      const src = "{% static '' %}"+val;
      box.innerHTML = '<img src="'+src+'" class="img-fluid" style="max-height:96px;">';
    }
  }
});
</script>
<script>
function previewImage(input, previewId){
  const file = input.files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = function(e){
      const preview = document.getElementById(previewId);
      if(preview.tagName.toLowerCase() === 'img'){
        preview.src = e.target.result;
      } else {
        preview.outerHTML = '<img id="'+previewId+'" src="'+e.target.result+'" class="img-fluid" style="max-height:96px;">';
      }
    }
    reader.readAsDataURL(file);
  }
}
</script>
<script>
document.addEventListener('change', function(e){
  if(e.target.name === 'image'){
    const file = e.target.files[0];
    if(file){
      const reader = new FileReader();
      reader.onload = function(ev){
        const box = e.target.closest('form').querySelector('.border.bg-light');
        box.innerHTML = '<img src="'+ev.target.result+'" class="img-fluid" style="max-height:96px;">';
      };
      reader.readAsDataURL(file);
    }
  }
});
</script>
<script>
document.addEventListener('input', function(e){
  if(e.target.name === 'color'){
    const val = e.target.value.trim();
    const box = e.target.closest('form').querySelector('.border.bg-light');
    if(val){
      box.innerHTML = '<div style="width:100%;height:100%;background:'+val+';"></div>';
    } else {
      box.innerHTML = '<span class="text-muted">Нет фона</span>';
    }
  }
});
</script>
{% endblock %}
