{% extends 'core/adminlte/admin_layout.html' %}

{% block content %}
<div class="container mt-4">
  <div class="card border p-4 shadow-sm">
    <h2 class="text-center mb-4">E-mail Рассылка</h2>

    <!-- Форма загрузки -->
    <form action="{% url 'core:admin_mailing' %}" method="post" enctype="multipart/form-data" class="mb-4 border-bottom pb-4">
      {% csrf_token %}
      <input type="hidden" name="action" value="upload_template">
      <div class="row align-items-center">
        <label class="col-form-label col-md-4">Загрузить новый HTML-шаблон</label>
        <div class="col-md-8">
            <div class="input-group"><input type="file" name="template_file" class="form-control" required><button class="btn btn-success" type="submit">Загрузить</button></div>
        </div>
      </div>
    </form>

    <!-- ОСНОВНОЙ БЛОК УПРАВЛЕНИЯ -->
    <div>
        <!-- СКРЫТОЕ ПОЛЕ ДЛЯ ХРАНЕНИЯ ID ВЫБРАННЫХ ПОЛЬЗОВАТЕЛЕЙ -->
      <input type="hidden" name="recipients" id="recipientsInput">

      <div class="row mb-3">
        <label class="col-form-label col-md-4">Выбрать получателей</label>
        <div class="col-md-8 d-flex align-items-center gap-3">
          <div class="form-check">
            <input type="radio" class="form-check-input" id="allUsersRadio" name="send_to" value="all" checked>
            <label class="form-check-label" for="allUsersRadio">Все пользователи ({{ all_users_count }})</label>
          </div>
          <div class="form-check">
            <input type="radio" class="form-check-input" id="selectiveUsersRadio" name="send_to" value="selective">
            <label class="form-check-label" for="selectiveUsersRadio">Выборочно (<span id="selectiveCount">0</span>)</label>
          </div>
          <button type="button" class="btn btn-secondary btn-sm" id="selectUsersBtn" data-bs-toggle="modal" data-bs-target="#userChoiceModal" disabled>
            Выбрать пользователей
          </button>
        </div>
      </div>

                <!-- ======================= МОДАЛЬНОЕ ОКНО ДЛЯ ВЫБОРА ПОЛЬЗОВАТЕЛЕЙ ======================= -->
        <div class="modal fade" id="userChoiceModal" tabindex="-1" aria-labelledby="userChoiceModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="userChoiceModalLabel">Выберите пользователей</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body p-0">
                <!-- Сюда будет загружена страница mailing_choice.html -->
                <iframe id="userChoiceFrame" src="about:blank" style="width: 100%; height: 60vh; border: none;"></iframe>
              </div>
            </div>
          </div>
        </div>

      <div class="row mb-3">
        <label class="col-form-label col-md-4">Отправлено писем:</label>
        <div class="col-md-8">
            <span id="emailCount" class="text-primary fw-bold">{% if last_campaign %}{{ last_campaign.sent_count }} / {{ last_campaign.total_recipients }}{% else %}0 / 0{% endif %}</span>
        </div>
      </div>
      <div class="row mb-3">
          <label class="col-form-label col-md-4">Статус:<span class="text-success">{% if last_campaign %}{{ last_campaign.get_status_display }}{% else %}Ожидание...{% endif %}</span></label>
        <div class="col-md-8">
             <span>Рассылка выполнена на:
                <span id="progressPercentage" class="text-success fw-bold">{{ initial_percentage }}%</span>
             </span>
        </div>
      </div>
      <div class="row mb-4">
          <div class="col-md-12">
              <div class="progress" style="height: 25px;">
                <div id="progressBar" class="progress-bar progress-bar-striped" role="progressbar" style="width: {{ initial_percentage }}%;" aria-valuenow="{{ initial_percentage }}" aria-valuemin="0" aria-valuemax="100">
                    <span id="progressText">{% if last_campaign %}{{ last_campaign.get_status_display }}{% else %}Ожидание...{% endif %}</span>
                </div>
            </div>
          </div>
      </div>

      <!-- Список шаблонов и управление -->
      <div class="row mt-4">
        <div class="col-md-8">
          <button id="startMailingBtn" class="btn btn-primary mb-3">Начать рассылку выбранных шаблонов</button>
        </div>
        <div class="col-md-4">
          <div class="border rounded p-3">
            <h6 class="mb-2">Выберите шаблоны для рассылки</h6>
            <div id="templatesList">
                {% for tpl in templates %}
                <div class="mb-1 d-flex justify-content-between align-items-center">
                    <div>
                        <input type="checkbox" class="form-check-input me-1 template-checkbox" value="{{ tpl.id }}" id="tpl-{{ tpl.id }}">
                        <label class="form-check-label mb-0" for="tpl-{{ tpl.id }}" title="{{ tpl.name }}">{{ tpl.name|truncatechars:25 }}</label>
                    </div>
                    <form action="{% url 'core:admin_mailing' %}" method="post" onsubmit="return confirm('Вы уверены?');">
                        {% csrf_token %}<input type="hidden" name="action" value="delete_template"><input type="hidden" name="template_id" value="{{ tpl.id }}">
                        <button type="submit" class="btn btn-link text-danger p-0">Удалить</button>
                    </form>
                </div>
                {% empty %}
                <p class="text-muted">Нет загруженных шаблонов.</p>
                {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ======================= JAVASCRIPT КОД НАЧИНАЕТСЯ ЗДЕСЬ ======================= -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Ссылки на элементы ---
    const startBtn = document.getElementById('startMailingBtn');
    const recipientsInput = document.getElementById('recipientsInput');
    const selectUsersBtn = document.getElementById('selectUsersBtn');
    const selectiveCountSpan = document.getElementById('selectiveCount');
    const selectiveUsersRadio = document.getElementById('selectiveUsersRadio');

    const userChoiceModalEl = document.getElementById('userChoiceModal');
    const userChoiceFrame = document.getElementById('userChoiceFrame');

    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const progressPercentage = document.getElementById('progressPercentage');
    const emailCount = document.getElementById('emailCount');
    const csrfToken = '{{ csrf_token }}';
    let progressInterval;
    let currentTaskId = "{{ last_campaign.task_id|default:'' }}";

    // --- Логика управления выбором получателей (без изменений) ---
    document.querySelectorAll('input[name="send_to"]').forEach(radio => {
        radio.addEventListener('change', function() {
            selectUsersBtn.disabled = this.value !== 'selective';
        });
    });

    // Логика открытия модального окна
    // так как Bootstrap делает это сам через data-атрибуты.
    // Вместо этого мы "слушаем" событие, когда модальное окно начинает открываться.
    if (userChoiceModalEl) {
        userChoiceModalEl.addEventListener('show.bs.modal', function (event) {
            const url = "{% url 'core:mailing_choice' %}";
            // Загружаем контент в iframe только один раз, при первом открытии
            if (userChoiceFrame.getAttribute('src') === 'about:blank') {
                userChoiceFrame.setAttribute('src', url);
            }
        });
    }

    // Эта функция будет вызвана из iframe (mailing_choice.html)
    window.updateSelectedUsers = function(ids) {
    const recipientsInput = document.getElementById('recipientsInput');
    const selectiveCountSpan = document.getElementById('selectiveCount');
    const selectiveUsersRadio = document.getElementById('selectiveUsersRadio');
    const userChoiceModalEl = document.getElementById('userChoiceModal');

    recipientsInput.value = JSON.stringify(ids);
    selectiveCountSpan.textContent = ids.length;
    selectiveUsersRadio.checked = true;
    selectUsersBtn.disabled = false;

    // Получаем экземпляр модального окна Bootstrap и закрываем его
    const modal = bootstrap.Modal.getInstance(userChoiceModalEl);
    modal.hide();

    const backdrop = document.querySelector('.modal-backdrop');
    if (backdrop) {
        backdrop.remove();
    }
        // Также Bootstrap добавляет класс на <body>, который мешает скроллу. Убираем и его.
        document.body.classList.remove('modal-open');
        document.body.style.overflow = ''; // Восстанавливаем скролл
        document.body.style.paddingRight = ''; // Восстанавливаем отступ
    }

    // --- Логика для кнопки "Начать рассылку" (без изменений) ---
    startBtn.addEventListener('click', function() {
        const selectedCheckboxes = document.querySelectorAll('.template-checkbox:checked');
        if (selectedCheckboxes.length === 0) {
            alert('Пожалуйста, выберите хотя бы один шаблон для рассылки.');
            return;
        }
        const templateIds = Array.from(selectedCheckboxes).map(cb => cb.value);
        startBtn.disabled = true;
        startBtn.textContent = 'Запускается...';
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', csrfToken);
        templateIds.forEach(id => formData.append('template_ids[]', id));
        const sendToValue = document.querySelector('input[name="send_to"]:checked').value;
        formData.append('send_to', sendToValue);
        if (sendToValue === 'selective') {
            formData.append('recipients', recipientsInput.value);
        }
        fetch("{% url 'core:start_mailing_api' %}", {
            method: 'POST',
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(data.message);
                currentTaskId = data.task_id;
                startChecking();
            } else {
                alert('Ошибка: ' + data.message);
                startBtn.disabled = false;
                startBtn.textContent = 'Начать рассылку';
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            alert('Произошла сетевая ошибка.');
            startBtn.disabled = false;
        });
    });

    // --- Функция, которая запрашивает и обновляет статус ---
    function updateStatus() {
        if (!currentTaskId) { return; }

        // ИСПРАВЛЕНО: Используем обратные кавычки ``
        fetch(`{% url 'core:get_mailing_status_api' %}?task_id=${currentTaskId}`)
        .then(response => response.json())
        .then(data => {
            if (data.status_code === 'no_campaign') { // Исправлено: status_code
                progressText.textContent = 'Нет данных';
                return;
            }

            progressBar.style.width = data.percentage + '%';
            progressBar.setAttribute('aria-valuenow', data.percentage);
            progressText.textContent = `${data.status_display}`;
            progressPercentage.textContent = data.percentage + '%';
            emailCount.textContent = `${data.sent} / ${data.total}`;

            if (data.is_running) {
                startBtn.disabled = true;
                startBtn.textContent = 'Рассылка в процессе...';
                progressBar.classList.add('progress-bar-animated');
            } else {
                startBtn.disabled = false;
                startBtn.textContent = 'Начать рассылку выбранных шаблонов';
                progressBar.classList.remove('progress-bar-animated');
                if (progressInterval) {
                    clearInterval(progressInterval);
                }
            }
        })
        .catch(error => {
            console.error('Status update error:', error);
            if (progressInterval) clearInterval(progressInterval);
        });
    }

    // --- Функция, которая запускает периодическую проверку ---
    function startChecking() {
        if (progressInterval) clearInterval(progressInterval);
        updateStatus();
        progressInterval = setInterval(updateStatus, 200);
    }

    // --- Первоначальная проверка при загрузке страницы ---
    if ("{{ last_campaign.status }}" === "in_progress") {
        startChecking();
    }
});
</script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}